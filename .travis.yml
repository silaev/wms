language: java

jdk: openjdk11

services: docker

addons:
  hosts:
    - mongo1
    - mongo2
    - mongo3

env:
  matrix:
    - IMG_TAG=v1 MONGODB_MODE=3 DOCKER_COMPOSE_VERSION=1.23.2
    # 0 - none, 1 - single replica set, 3 - triple replica set
    #- MONGO_VERSION=v3 MONGODB_MODE=1
  global:
    - secure: oxsPRvg3lLLoQh3glohD98r/6Om98DttN9rEaHny/Z0AJ0A8Bs/YSr1L21pUwY5cfjfeDeozT22grNi/ZvYPn2dc0VcgrnmF7A8IiCGMhlCJISskzELygp3Tgy4kYeAxVuuNSLwSY4V3KNvA0bf2CszhQ3eegTEBJfn3VOysuVUn1KeKDbV9el+K8XZaOFqT2vX2CBjHHTTRZSwRHfgaPTdgKGSVO+q1mx1g68Lb0JmnEQqBFFNhvvYmmI2rbdIk82ivVRwXabOdK4xjH7m4Zz7JFhBplB+9bykM09X4jseFj8EQ8eUP95GzNAPPFEYXZIeBoQ/g3n//7uN32++V/eg/dpHW4Cx/hMoZz3w+/khRsATO4DiUh8ZgfHiYyUIdDsvpZ9shqgztKXFy7qH6bpXWlKiJChmSXdekMen+2UwUb1K5y8IG1qy1WTkvTo7GVxrtk7X02U7JwJnLXt5wHOz+1g/wSeW7vO28Kkd9Rj2lNxJovemCWCYjLZQKZgwxLdHMzclVGBRUb14yjoBIiS7Ejn02okUAHlQP6xl1XZuXQ8kA+dvVKSQGQNuNLoRvPLrXAAydhaqiR4GYjBm5c0cJ9/KzaPT8XqA6HSBLtf+9/Pl5TZGxHWxCbyIUGopdo9V7u4cmxoPQ2SaKIGBZyzist/EzXDxtbvUJgwD8KgY=
    - secure: qMTzuymObnML29wNnNvAgQYz+c6HyTKVXDHVcCJbhv873y4bE4S/lQ9gF3gHiu5lJONR7idiio6yKW7ECdP1JNGg9lHVZAOCY7/cVhY75SScG0kv47mYkbx6IFKi+KeC5gfdYyTLEkZ/sWcZxO2Mmzx3Q4JvyJZ5vwCOeITfwOs+DuAmXlDNPVv7mQMFzLJmTJqd+F6aNUZiUaX2p/ELP+fF5UcmDgrSfDvIioeKV/ufqV/ZI3xNFu9+c/43ZW0+Vl57Wsx1gK74quDewsev0h8S4kWAE4XFZWz+DBJ0XZbUDCFzRoTJuxLnXvtkddTRGEyDDml+6SRf5Ro4DIxUbCQixpKAwzK0kSRwF4AO8iEpzK1RcVNYcZI9Y+G14fEg89kirZUrI/i5xewNP+359+Imebhmaezbj4ajd/NkniHlPj06uQNJJXg2n8w93LCMjhnX/qXWFsgfpmsLofn8/KE9g69xgfMspOuLV1wFgqTku+Yg09D763YUwml/0SzDF4Mc5l2bnVCP7uoZzbzmccHhaJrscLtFbG+VUA9F7aalqK3qfjU07yznbBtIgwK8oije3KLS4AHOOfU1VizPfOuksTz1lSQYQ7YCOixOMGItrh3MovDFekvFkGPfkRqz6gu9Yh1izFsKdTzgb2EcUv7eImjJytkaK8duJ56zzQQ=

before_install:
  - chmod +x gradlew;

  - if [[ $MONGODB_MODE == 3 ]]; then
    echo "*** update docker to latest";
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -;
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable";
    sudo apt-get update;
    sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce;

    echo "*** update docker-compose to DOCKER_COMPOSE_VERSION";
    sudo rm /usr/local/bin/docker-compose;
    curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose;
    chmod +x docker-compose;
    sudo mv docker-compose /usr/local/bin;

    echo "*** install 3 node replica set MongoDB";

    chmod +x tools/docker_image_tag_exists.sh;
    if [[ $(./tools/docker_image_tag_exists.sh s256/wms-mongo $IMG_TAG) == "true" ]]; then
    echo "*** found image s256/wms-mongo:$IMG_TAG";
    else
    echo "*** not found image s256/wms-mongo:$IMG_TAG, preparing build and push to Docker Hub...";
    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin;
    docker build -t s256/wms-mongo:{$IMG_TAG} -f Dockerfile.mongo .;
    docker push s256/wms-mongo:{$IMG_TAG};
    fi

    docker-compose -f docker-compose.yml up -d;
    docker-compose exec mongo1 /bin/sh -c "mongo --port 50001 < /scripts/init.js";
    fi

    if [[ $MONGODB_MODE == 1 ]]; then
    echo "*** install a single replica set MongoDB";
    chmod +x tools/wait-for-mongo.sh;
    docker network create mongo-cluster;
    docker run --name mongo -p 27017:27017 -d --net mongo-cluster mongo:4.0.10 --replSet rs0;
    ./tools/wait-for-mongo.sh;
    docker exec -it mongo mongo --eval "printjson(rs.initiate())";
    fi

after_success:
  - if [ $TRAVIS_BRANCH == 'master' ]; then
    echo "*** send stats to codecov";
    bash <(curl -s https://codecov.io/bash);
    fi

script:
  - if [[ $MONGODB_MODE == 1 ]]; then
    echo "*** run gradlew with spring.data.mongodb.uri param";
    ./gradlew clean build -D"spring.data.mongodb.uri"="mongodb://localhost:27017/test";
    else
    echo "*** run gradlew";
    ./gradlew clean build;
    fi

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
  - $HOME/.m2/repository/